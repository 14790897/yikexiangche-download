name: Build and Release ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements-gui.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-gui.txt

    - name: Build executable
      run: |
        Write-Host "Building ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨..." -ForegroundColor Cyan
        pyinstaller build.spec --clean
      shell: pwsh

    - name: Get version info
      id: version
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $VERSION = "${{ github.event.inputs.tag }}"
        } else {
          $VERSION = "${{ github.event.release.tag_name }}"
        }
        $COMMIT = git rev-parse --short HEAD
        $DATE = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        
        echo "version=$VERSION" >> $env:GITHUB_OUTPUT
        echo "commit=$COMMIT" >> $env:GITHUB_OUTPUT
        echo "date=$DATE" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Package release files
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Path release -Force
        Copy-Item "dist\\BaiduPhotoDownloader.exe" release\\
        # é‡å‘½åä¸ºä¸­æ–‡åï¼ˆä»…æœ¬åœ°ä½¿ç”¨ï¼‰
        Rename-Item "release\\BaiduPhotoDownloader.exe" "ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨.exe"
        Copy-Item icon.ico release\\ -ErrorAction SilentlyContinue
        Copy-Item icon.png release\\ -ErrorAction SilentlyContinue
        
        # Create VERSION.txt with multi-line content
        $versionText = "ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨`n"
        $versionText += "=========================================`n"
        $versionText += "Version: ${{ steps.version.outputs.version }}`n"
        $versionText += "Commit: ${{ steps.version.outputs.commit }}`n"
        $versionText += "Build Date: ${{ steps.version.outputs.date }}`n"
        $versionText += "Platform: Windows 10/11`n`n"
        $versionText += "åŠŸèƒ½ç‰¹ç‚¹:`n"
        $versionText += "- ğŸ“¥ æ‰¹é‡ä¸‹è½½ç™¾åº¦ä¸€åˆ»ç›¸å†Œç…§ç‰‡`n"
        $versionText += "- ğŸ“… æ”¯æŒæŒ‰æ—¥æœŸè¿‡æ»¤ç…§ç‰‡`n"
        $versionText += "- âš¡ 32çº¿ç¨‹å¹¶å‘ä¸‹è½½ï¼Œé€Ÿåº¦å¿«`n"
        $versionText += "- ğŸ”„ æ–­ç‚¹ç»­ä¼ ï¼Œæ”¯æŒæš‚åœæ¢å¤`n"
        $versionText += "- âœ… MD5æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒ`n"
        $versionText += "- ğŸ“Š å®æ—¶è¿›åº¦æ˜¾ç¤ºå’Œæ—¥å¿—è®°å½•`n"
        $versionText += "- ğŸ¨ ç°ä»£åŒ–å›¾å½¢ç•Œé¢ (PySide6)`n`n"
        $versionText += "ç³»ç»Ÿè¦æ±‚:`n"
        $versionText += "- Windows 10/11`n"
        $versionText += "- ç™¾åº¦ç½‘ç›˜è´¦å·`n`n"
        $versionText += "å¿«é€Ÿå¼€å§‹:`n"
        $versionText += "1. è¿è¡Œç¨‹åº`n"
        $versionText += "2. åœ¨é…ç½®é¡µé¢å¡«å†™ BDSToken å’Œ Cookie`n"
        $versionText += "3. ç‚¹å‡»è·å–å…ƒæ•°æ®`n"
        $versionText += "4. ç‚¹å‡»ä¸‹è½½ç…§ç‰‡`n"
        Set-Content -Path release\\VERSION.txt -Encoding UTF8 -Value $versionText
        
        # Copy README as usage guide
        if (Test-Path README-NEW.md) {
          Copy-Item README-NEW.md release\\README.txt
        } elseif (Test-Path README.md) {
          Copy-Item README.md release\\README.txt
        }
        
        # Copy documentation files
        Copy-Item é…ç½®è¯´æ˜.md release\\ -ErrorAction SilentlyContinue
        Copy-Item æ—¥æœŸè¿‡æ»¤ä½¿ç”¨è¯´æ˜.md release\\ -ErrorAction SilentlyContinue
        Copy-Item BUILD.md release\\ -ErrorAction SilentlyContinue
        Copy-Item settings.json.example release\\ -ErrorAction SilentlyContinue
        
        # Compress to zip
        Compress-Archive -Path "release\\*" -DestinationPath "ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨-${{ steps.version.outputs.version }}-Windows.zip"

    - name: Upload to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨-${{ steps.version.outputs.version }}-Windows.zip
          release/VERSION.txt
          release/README.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release (manual trigger)
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.tag }}
        name: ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨ ${{ github.event.inputs.tag }}
        body: |
          ## ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨ ${{ github.event.inputs.tag }}
          
          ### ğŸ“¦ ä¸‹è½½
          - `ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨.exe` - Windows å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¸¦å›¾æ ‡ï¼‰- åœ¨ ZIP åŒ…å†…
          - `ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨-${{ github.event.inputs.tag }}-Windows.zip` - å®Œæ•´åŒ… (åŒ…å«ä½¿ç”¨è¯´æ˜å’Œæ–‡æ¡£)
          
          ### âœ¨ åŠŸèƒ½ç‰¹ç‚¹
          - ğŸ“¥ æ‰¹é‡ä¸‹è½½ç™¾åº¦ä¸€åˆ»ç›¸å†Œç…§ç‰‡
          - ğŸ“… æ”¯æŒæŒ‰æ—¥æœŸè¿‡æ»¤ç…§ç‰‡ï¼ˆbefore/after æ¨¡å¼ï¼‰
          - âš¡ 32çº¿ç¨‹å¹¶å‘ä¸‹è½½ï¼Œé€Ÿåº¦å¿«
          - ğŸ”„ æ–­ç‚¹ç»­ä¼ ï¼Œæ”¯æŒæš‚åœæ¢å¤
          - âœ… MD5æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒ
          - ğŸ“Š å®æ—¶è¿›åº¦æ˜¾ç¤ºå’Œæ—¥å¿—è®°å½•
          - ğŸ¨ ç°ä»£åŒ–å›¾å½¢ç•Œé¢ (åŸºäº PySide6)
          - ğŸ” è‡ªåŠ¨æ£€æµ‹æœ¬åœ°å·²ä¸‹è½½æ–‡ä»¶ï¼Œé¿å…é‡å¤
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11
          - ç™¾åº¦ç½‘ç›˜è´¦å·
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½å¹¶è¿è¡Œ `ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨.exe`
          2. åœ¨ã€Œé…ç½®ã€é¡µé¢å¡«å†™ BDSToken å’Œ Cookieï¼ˆä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·è·å–ï¼‰
          3. ï¼ˆå¯é€‰ï¼‰è®¾ç½®æ—¥æœŸè¿‡æ»¤æ¡ä»¶
          4. ç‚¹å‡»ã€Œä¿å­˜é…ç½®ã€
          5. åœ¨ã€Œä¸‹è½½ã€é¡µé¢ç‚¹å‡»ã€Œè·å–å…ƒæ•°æ®ã€
          6. ç­‰å¾…å®Œæˆåç‚¹å‡»ã€Œä¸‹è½½ç…§ç‰‡ã€
          
          ### ğŸ“– è·å–é…ç½®ä¿¡æ¯
          1. æ‰“å¼€ [ç™¾åº¦ä¸€åˆ»ç›¸å†Œç½‘é¡µç‰ˆ](https://photo.baidu.com/)
          2. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
          3. åˆ‡æ¢åˆ°ã€Œç½‘ç»œã€(Network) æ ‡ç­¾
          4. ç‚¹å‡»ã€ŒFetch/XHRã€ç­›é€‰
          5. åœ¨ç›¸å†Œä¸­æ“ä½œï¼Œæ‰¾åˆ° `list?clienttype=70...` è¯·æ±‚
          6. åœ¨ã€Œæ ‡å¤´ã€ä¸­å¤åˆ¶ Cookie å€¼
          7. åœ¨ã€Œè´Ÿè½½ã€ä¸­å¤åˆ¶ bdstoken å€¼
          
          è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹å‹ç¼©åŒ…å†…çš„æ–‡æ¡£
          
          ---
          
          **æ„å»ºä¿¡æ¯**
          - ç‰ˆæœ¬: ${{ steps.version.outputs.version }}
          - æäº¤: ${{ steps.version.outputs.commit }}
          - æ—¥æœŸ: ${{ steps.version.outputs.date }}
          - Python: 3.12
          - GUIæ¡†æ¶: PySide6
        files: |
          ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨-${{ github.event.inputs.tag }}-Windows.zip
          release/VERSION.txt
          release/README.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨-${{ steps.version.outputs.version }}
        path: |
          release/
          ç™¾åº¦ä¸€åˆ»ç›¸å†Œä¸‹è½½å™¨-${{ steps.version.outputs.version }}-Windows.zip
        retention-days: 30
